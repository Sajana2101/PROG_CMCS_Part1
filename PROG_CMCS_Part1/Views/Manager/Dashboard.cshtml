@model IEnumerable<PROG_CMCS_Part1.Models.Claim>

@{
    ViewData["Title"] = "Manager Dashboard";
}
<!-- Dashboard to show claims submitted-->

<h2>Manager Dashboard</h2>

<form method="get" asp-action="Dashboard" class="mb-3">
    <label>Filter by Status: </label>
    <select name="statusFilter" onchange="this.form.submit()" class="form-select w-auto d-inline-block">
        <option value="All">All</option>
        <option value="Pending Verification">Pending Verification</option>
        <option value="Verified – Pending Approval">Verified – Pending Approval</option>
        <option value="Approved">Approved</option>
        <option value="Rejected">Rejected</option>
    </select>
    <button type="submit" name="statusFilter" value="All" class="btn btn-secondary ms-2">Reset</button>
</form>
<!-- Function to style each claim based on its status -->
@functions {
    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Approved" => "bg-success text-white",
            "Rejected" => "bg-danger text-white",
            "Pending Verification" => "bg-secondary text-white",
            "Verified – Pending Approval" => "bg-warning text-dark",
            _ => "bg-light text-dark"
        };
    }
}
<!-- Display the claims table -->
<table class="table table-striped table-bordered mt-3">
    <thead class="table-dark">
        <tr>
            <th>Claim ID</th>
            <th>Lecturer</th>
            <th>Module Code</th>
            <th>Month</th>
            <th>Total Hours</th>
            <th>Total Amount</th>
            <th>Date Submitted</th>
            <th>Status</th>
            <th>Manager</th>
            <th>Supporting Document</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var claim in Model)
        {
            <tr>
                <td>@claim.Id</td>
                <td>@claim.LecturerName</td>
                <td>@claim.ModuleCode</td>
                <td>@claim.Month</td>
                <td>@claim.HoursWorked</td>
                <td>R @(claim.HoursWorked* claim.HourlyRate)</td>
                <td>@claim.DateSubmitted.ToString("dd MMM yyyy")</td>
                <td class="@GetStatusClass(claim.Status) text-center">@claim.Status</td>
                <td>@claim.ManagerName</td>

                <!-- Display uploaded documents -->
                <td>
                    @if (claim.EncryptedDocuments != null && claim.EncryptedDocuments.Any())
                    {
                        <ul class="list-unstyled mb-0">
                            @for (int i = 0; i < claim.EncryptedDocuments.Count; i++)
                            {
                                var encryptedFile = claim.EncryptedDocuments[i];
                                var originalName = claim.OriginalDocuments.Count > i
                                ? claim.OriginalDocuments[i]
                                : encryptedFile;

                                <li>
                                    <a asp-action="DownloadFile"
                                       asp-controller="Manager"
                                       asp-route-claimId="@claim.Id"
                                       asp-route-file="@encryptedFile"
                                       class="btn btn-sm btn-outline-primary mb-1">
                                        @originalName
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <span>No document</span>
                    }
                </td>

              
                <td>
                    @if (claim.Status == "Pending Verification" || claim.Status == "Verified – Pending Approval")
                     <!--
                            Added "Enter your name" field to ensure the managers intentionally verifies or rejects the claim,
                            preventing accidental status changes.
                        -->
                    {
                        <form asp-action="UpdateStatus" method="post" class="d-inline-block">
                            <input type="hidden" name="id" value="@claim.Id" />
                            <input type="hidden" name="newStatus" value="Approved" />
                            <input type="text" name="managerName" placeholder="Your Name" required class="form-control form-control-sm mb-1" />
                            <button type="submit" class="btn btn-success btn-sm">Approve</button>
                        </form>

                        <form asp-action="UpdateStatus" method="post" class="d-inline-block ms-1">
                            <input type="hidden" name="id" value="@claim.Id" />
                            <input type="hidden" name="newStatus" value="Rejected" />
                            <input type="text" name="managerName" placeholder="Your Name" required class="form-control form-control-sm mb-1" />
                            <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                        </form>
                    }
                    else
                    {
                        <a class="btn btn-info btn-sm" asp-action="ClaimDetails" asp-route-id="@claim.Id">Details</a>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>
